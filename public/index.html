<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú—É–ª—å—Ç–∏-—á–∞—Ç –±–æ—Ç</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="sidebar">

    <button class="createChat" onclick="createChat()">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–± —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç</button>
    <div id="chat-list" class="chat-list"></div>
    
  </div>


  <div class="chat-area">
    <div class="chat-box" id="chat-box"></div>
    <div class="input-area">
      <input type="text" id="userInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
      <button id="sendBtn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button onclick="clearChat()" id="resetBtn">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
      <br><br>

     
      <button id="previewBtn" onclick="previewData()" disabled>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
      <button id="finalSubmitBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–∞–π—Ç</button>
     </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Ç–∞ -->
<div id="editChatModal" class="modal">
  <div class="modal-content">
      <span class="close" onclick="closeEditModal()">&times;</span>
      <h2>–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞</h2>
      <input type="text" id="newChatName" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞">
      <button onclick="saveNewChatName()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>


  <div id="modalOverlay" onclick="closeModal()"></div>
  <div id="editModal">
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã</h3>
    <div id="editFields"></div>
    <button onclick="applyChanges()" id="applyBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    <button onclick="closeModal()" id="closeModalBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>


<script>
const editModal = document.getElementById('editModal');

let chats = {};
let currentChatId = null;

document.addEventListener('DOMContentLoaded', () => {
    createChat(); // Initialize the first chat on load
});


// function createChat() {
//     const chatId = `chat_${new Date().getTime()}`;
//     if (!chats[chatId]) {
//         chats[chatId] = {
//             messages: [],
//             parsedData: {}
//         };
//     }

//     const chatList = document.getElementById('chat-list');
//     const chatButton = document.createElement('button');
//     chatButton.textContent = `–ß–∞—Ç ${Object.keys(chats).length}`;
//     chatButton.onclick = () => switchChat(chatId);
//     chatList.appendChild(chatButton);

//     if (Object.keys(chats).length === 1) {
//         switchChat(chatId); // Automatically switch to the first chat when created
//     }
//     updateEditButtonState(); // Update button states right after creating a chat
// }

function createChat() {
    const chatId = `chat_${new Date().getTime()}`;
    if (!chats[chatId]) {
        chats[chatId] = {
            name: `–ß–∞—Ç ${Object.keys(chats).length + 1}`, // –ó–∞–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞
            messages: [],
            parsedData: {}
        };
    }

    const chatList = document.getElementById('chat-list');
    const chatDiv = document.createElement('div');
    chatDiv.className = 'chat-entry';
    chatDiv.innerHTML = `
      <button onclick="switchChat('${chatId}')">${chats[chatId].name}</button>
      <span onclick="editChatName('${chatId}')" class="edit-icon">‚úèÔ∏è</span>
      <span onclick="deleteChat('${chatId}')" class="delete-icon">üóëÔ∏è</span>
    `;
    chatList.appendChild(chatDiv);

    if (Object.keys(chats).length === 1) {
        switchChat(chatId); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π —Å–æ–∑–¥–∞–Ω–Ω—ã–π —á–∞—Ç
    }
    updateChatList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
}




function updateEditButtonState() {
    const currentParsedData = chats[currentChatId] ? chats[currentChatId].parsedData : {};
    let hasErrors = Object.values(currentParsedData).some(data => !data || (typeof data === 'object' && Object.values(data).some(v => !v)));

    document.getElementById('previewBtn').disabled = hasErrors;
    document.getElementById('finalSubmitBtn').disabled = hasErrors;
}

function switchChat(chatId) {
    if (currentChatId !== chatId) {
        currentChatId = chatId;
        updateChatBox(); // –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —á–∞—Ç–∞, –∑–∞–≥—Ä—É–∂–∞—è —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
        updateEditButtonState(); // –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
    }
}


// function updateChatBox() {
//     const chatBox = document.getElementById('chat-box');
//     chatBox.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —á–∞—Ç–∞

//     if (chats[currentChatId] && chats[currentChatId].messages) {
//         chats[currentChatId].messages.forEach(msg => {
//             const messageDiv = document.createElement('div');
//             messageDiv.className = `message ${msg.sender}`;
//             messageDiv.textContent = msg.text;
//             chatBox.appendChild(messageDiv);
//         });
//     }
//     chatBox.scrollTop = chatBox.scrollHeight; // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —á–∞—Ç –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
// }
// function updateChatBox() {
//     const chatBox = document.getElementById('chat-box');
//     chatBox.innerHTML = ''; // Clear the chat box

//     // If there are messages, render them
//     if (chats[currentChatId] && chats[currentChatId].messages.length > 0) {
//         chats[currentChatId].messages.forEach(msg => {
//             const messageDiv = document.createElement('div');
//             messageDiv.className = `message ${msg.sender}`;
//             messageDiv.textContent = msg.text;
//             chatBox.appendChild(messageDiv);
//         });
//         chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom of the chat
//     }
// }

function updateChatBox() {
    const chatBox = document.getElementById('chat-box');
    chatBox.innerHTML = ''; // –û—á–∏—â–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–∫–Ω–µ —á–∞—Ç–∞

    // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ, –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∏—Ö
    if (chats[currentChatId] && chats[currentChatId].messages.length > 0) {
        chats[currentChatId].messages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.sender}`;
            messageDiv.textContent = msg.text;
            chatBox.appendChild(messageDiv);
        });
    }
    chatBox.scrollTop = chatBox.scrollHeight; // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
}

document.getElementById('resetBtn').addEventListener('click', clearChat);

function updateEditButtonState() {
    // This needs to check if the current chat data is complete or if fields are missing
    const currentParsedData = chats[currentChatId] ? chats[currentChatId].parsedData : {};
    let hasErrors = Object.entries(currentParsedData).some(([key, value]) => {
        return (!value || value.trim() === '') && !key.startsWith("–†–µ–±–µ–Ω–æ–∫ ");
    }) || (currentParsedData["–î–µ—Ç–∏"] && currentParsedData["–î–µ—Ç–∏"].some(child => {
        return Object.values(child).some(val => !val || val.toLowerCase().includes('—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–æ–¥'));
    }));

    document.getElementById('previewBtn').disabled = hasErrors;
    document.getElementById('finalSubmitBtn').disabled = hasErrors;
}

function clearChat() {
    if (chats[currentChatId]) {
        // Clear the messages for the current chat
        chats[currentChatId].messages = [];
        // Optionally reset the parsed data for the current chat
        chats[currentChatId].parsedData = {};
        // Clear the display of the chat box
        updateChatBox();
        // Clear any data shown in the edit fields if necessary
        clearEditFields();
        // Update the state of the buttons
        updateEditButtonState();
    }
}
function clearEditFields() {
    const editFields = document.getElementById('editFields');
    if (editFields) {
        editFields.innerHTML = ''; // Clears any rendered input fields
    }
}


const sendBtn = document.getElementById('sendBtn');
sendBtn.addEventListener('click', async () => {
    const userInput = document.getElementById('userInput');
    const message = userInput.value.trim();
    if (!message) return;
    addMessage('–í—ã: ' + message, 'user');
    userInput.value = '';

    try {
        const response = await fetch('/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, currentForm: chats[currentChatId].parsedData })
        });
        const data = await response.json();
        handleFormData(data);
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞:', err);
        addMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.', 'assistant');
    }
});

function handleFormData(data) {
    let hasErrors = false;
    const missingQuestions = [];
    let currentChildIndex = null;

    const lines = data.reply.split('\n').filter(line => line.trim().length > 0);
    lines.forEach(line => {
        const parts = line.split(':');
        if (parts.length < 2) return;

        const key = parts[0].trim();
        const value = parts[1].trim();

        const currentParsedData = chats[currentChatId].parsedData;

        if (key.startsWith('–†–µ–±–µ–Ω–æ–∫')) {
            const index = parseInt(key.split(' ')[1]) - 1;
            currentChildIndex = index;
            if (!currentParsedData["–î–µ—Ç–∏"]) currentParsedData["–î–µ—Ç–∏"] = [];
            if (!currentParsedData["–î–µ—Ç–∏"][currentChildIndex]) currentParsedData["–î–µ—Ç–∏"][currentChildIndex] = {};
        } else if (currentChildIndex !== null && key.startsWith('- ')) {
            const subKey = key.replace(/^- /, '').trim();
            if (!value || value.toLowerCase().includes('—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–æ–¥')) {
                hasErrors = true;
                missingQuestions.push(`–†–µ–±–µ–Ω–æ–∫ ${currentChildIndex + 1} ‚Äì ${subKey}: (–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç)`);
            } else {
                currentParsedData["–î–µ—Ç–∏"][currentChildIndex][subKey] = value;
            }
        } else {
            if (!value || value.toLowerCase().includes('—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–æ–¥')) {
                hasErrors = true;
                missingQuestions.push(`${key}: (–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç)`);
            } else {
                currentParsedData[key] = value;
            }
        }
    });

    updateEditButtonState(); // Ensure buttons are updated with the new data state

    if (missingQuestions.length > 0) {
        addMessage('‚ö†Ô∏è –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —É—Ç–æ—á–Ω–∏—Ç–µ:', 'assistant');
        missingQuestions.forEach(q => addMessage(q, 'assistant'));
    } else {
        addMessage('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã!', 'assistant');
    }
}


// chatId for sent and recevieng when sending the messages use chat id and when receive the same

function addMessage(text, sender) {
    if (!chats[currentChatId]) {
        console.error('No active chat to add messages');
        return; // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —á–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
    }

    const msg = {
        text: text,
        sender: sender
    };

    chats[currentChatId].messages.push(msg);
    updateChatBox(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–∞—Ç–∞
}




// function updateEditButtonState() {
//     const currentParsedData = chats[currentChatId].parsedData;
//     let hasErrors = Object.entries(currentParsedData).some(([key, value]) => {
//         return (!value || value.trim() === '') && !key.startsWith("–†–µ–±–µ–Ω–æ–∫ ");
//     }) || (currentParsedData["–î–µ—Ç–∏"] && currentParsedData["–î–µ—Ç–∏"].some(child => {
//         return Object.values(child).some(val => !val || val.toLowerCase().includes('—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–≤–æ–¥'));
//     }));

//     document.getElementById('previewBtn').disabled = hasErrors;
//     document.getElementById('finalSubmitBtn').disabled = hasErrors;
// }

// function updateEditButtonState() {
//     // Disable buttons if there are no messages or parsed data fields are incomplete
//     const hasMessages = chats[currentChatId] && chats[currentChatId].messages.length > 0;
//     const currentParsedData = chats[currentChatId] ? chats[currentChatId].parsedData : {};
//     let hasErrors = !hasMessages || Object.values(currentParsedData).some(data => !data || (typeof data === 'object' && Object.values(data).some(v => !v)));

//     document.getElementById('previewBtn').disabled = hasErrors;
//     document.getElementById('finalSubmitBtn').disabled = hasErrors;
// }

function updateEditButtonState() {
    // Check if there are any messages or data entries in the current chat
    const hasMessages = chats[currentChatId] && chats[currentChatId].messages.length > 0;
    const hasData = chats[currentChatId] && Object.keys(chats[currentChatId].parsedData).length > 0;

    // Disable buttons if no messages and no data
    document.getElementById('previewBtn').disabled = !hasMessages && !hasData;
    document.getElementById('finalSubmitBtn').disabled = !hasMessages && !hasData;
}

// Call this function initially to set up button states correctly
updateEditButtonState();

document.getElementById('previewBtn').addEventListener('click', () => {
    const editFields = document.getElementById('editFields');
    editFields.innerHTML = '';

    const currentParsedData = chats[currentChatId].parsedData;
    Object.entries(currentParsedData).forEach(([key, value]) => {
        if (typeof value === 'object' && value !== null) {
            // Assuming nested objects may not be directly editable or should be handled differently
            console.log('Nested data needs specific handling:', key);
        } else {
            createField(key, value);
        }
    });

    function createField(key, value) {
        const div = document.createElement('div');
        div.className = 'field';

        const label = document.createElement('label');
        label.textContent = key;

        const input = document.createElement('input');
        input.type = 'text';
        input.value = value;
        input.dataset.key = key;

        div.appendChild(label);
        div.appendChild(input);
        editFields.appendChild(div);
    }

    
    document.getElementById('modalOverlay').style.display = 'block';
    document.getElementById('editModal').style.display = 'block';
});


let isSubmitting = false;

document.getElementById('finalSubmitBtn').addEventListener('click', () => {
    if (isSubmitting) return;
    isSubmitting = true;

    const currentParsedData = chats[currentChatId].parsedData;
    fetch('/finalProcess', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ updatedForm: currentParsedData })
    })
    .then(response => response.json())
    .then(finalData => {
        console.log('Processed JSON:', finalData.reply);
        return fetch('/finalSubmit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(finalData.reply)
        });
    })
    .then(response => response.json())
    .then(data => {
        addMessage('–§–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã', 'system');
        isSubmitting = false; // Reset the flag
    })
    .catch(error => {
        console.error('Error sending data:', error);
        addMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö.', 'assistant');
        isSubmitting = false; // Reset the flag even on error
    });
});



function previewData() {
    const editFields = document.getElementById('editFields');
    editFields.innerHTML = '';
    Object.entries(chats[currentChatId].parsedData).forEach(([key, value]) => {
        if (typeof value === 'object') {
            Object.entries(value).forEach(([childKey, childValue]) => {
                createField(`${key} ${childKey}`, childValue);
            });
        } else {
            createField(key, value);
        }
    });
    document.getElementById('modalOverlay').style.display = 'block';
    document.getElementById('editModal').style.display = 'block';
}

function createField(key, value) {
    const div = document.createElement('div');
    div.className = 'field';
    const label = document.createElement('label');
    label.textContent = key;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = value;
    input.dataset.key = key;
    div.appendChild(label);
    div.appendChild(input);
    document.getElementById('editFields').appendChild(div);
}

function applyChanges() {
    const inputs = document.querySelectorAll('#editFields input');
    inputs.forEach(input => {
        const keys = input.dataset.key.split(' '); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ –∫–ª—é—á–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –≤–∏–¥–∞ "–î–µ—Ç–∏ 1 –∏–º—è"
        if (keys[0] === "–î–µ—Ç–∏" && keys.length === 3) {
            const childIndex = parseInt(keys[1]) - 1;
            const field = keys[2];

            if (!chats[currentChatId].parsedData["–î–µ—Ç–∏"]) {
                chats[currentChatId].parsedData["–î–µ—Ç–∏"] = [];
            }
            if (!chats[currentChatId].parsedData["–î–µ—Ç–∏"][childIndex]) {
                chats[currentChatId].parsedData["–î–µ—Ç–∏"][childIndex] = {};
            }
            chats[currentChatId].parsedData["–î–µ—Ç–∏"][childIndex][field] = input.value;
        } else {
            // –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç –ø–æ–¥ —Ñ–æ—Ä–º–∞—Ç "–î–µ—Ç–∏ X –ø–æ–ª–µ"
            chats[currentChatId].parsedData[input.dataset.key] = input.value;
        }
    });
    addMessage("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!", "system");
    closeModal();
    updateChatBox(); // –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    updateEditButtonState(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
}


function closeModal() {
    document.getElementById('modalOverlay').style.display = 'none';
    document.getElementById('editModal').style.display = 'none';
}



function updateEditButtonState() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–µ–∫—É—â–∏–π —á–∞—Ç –∏ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
    const currentParsedData = chats[currentChatId] ? chats[currentChatId].parsedData : {};

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏ –≤ –¥–∞–Ω–Ω—ã—Ö
    let hasErrors = !currentParsedData || Object.keys(currentParsedData).length === 0; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤–æ–æ–±—â–µ
    hasErrors = hasErrors || Object.entries(currentParsedData).some(([key, value]) => {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ –µ—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ –µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
        if (typeof value === 'object' && value !== null) {
            return Object.values(value).some(v => !v); // –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º true
        } else {
            return !value; // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ
        }
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–ª–∏—á–∏—è –æ—à–∏–±–æ–∫
    document.getElementById('previewBtn').disabled = hasErrors;
    document.getElementById('finalSubmitBtn').disabled = hasErrors;
}

function updateChatList() {
    const chatList = document.getElementById('chat-list');
    chatList.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
    Object.keys(chats).forEach(chatId => {
        const chatDiv = document.createElement('div');
        chatDiv.className = 'chat-entry';
        chatDiv.innerHTML = `
          <button onclick="switchChat('${chatId}')">${chats[chatId].name}</button>
          <span onclick="editChatName('${chatId}')" class="edit-icon">‚úèÔ∏è</span>
          <span onclick="deleteChat('${chatId}')" class="delete-icon">üóëÔ∏è</span>
        `;
        chatList.appendChild(chatDiv);
    });
}



// function editChatName(chatId) {
//     const newName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Ç–∞:", chats[chatId].name);
//     if (newName) {
//         chats[chatId].name = newName;
//         updateChatList();
//     }
// }

function editChatName(chatId) {
    const modal = document.getElementById('editChatModal');
    const input = document.getElementById('newChatName');
    input.value = chats[chatId].name; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    modal.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è
    window.saveNewChatName = function() {
        if (input.value.trim() !== '') {
            chats[chatId].name = input.value.trim();
            updateChatList();
            modal.style.display = 'none';
        } else {
            alert("–ù–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!");
        }
    }
}

function closeEditModal() {
    document.getElementById('editChatModal').style.display = 'none';
}


function deleteChat(chatId) {
    if (confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?")) {
        delete chats[chatId];
        if (currentChatId === chatId) {
            currentChatId = null;
            document.getElementById('chat-box').innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç—å –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞
        }
        updateChatList();
    }
}


</script>
</body>
</html>